#!/bin/bash

HOMEBREW_PREFIX=$(brew --prefix)
# scripts_dir="$HOMEBREW_PREFIX/share/support/scripts/scripts"
# Obtener el directorio donde estÃ¡ ubicado este script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
scripts_dir="$SCRIPT_DIR/scripts"
source "$scripts_dir/global_vars.sh"
source "$scripts_dir/support/logo.sh"

echo ""
echo -e "${BOLD}versiÃ³n: ${VERSION}"
echo -e "${BOLD}propiedad: Rudo apps${NC}"

echo ""
echo -e "${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo -e "${BOLD}Cargando prerequisitos:${NC}"
echo ""
if [ -z "$HOMEBREW_PREFIX" ]; then
    echo "No se encontrÃ³ el prefijo de Homebrew. Verifica si brew estÃ¡ instalado correctamente."
else
    echo "âœ… El prefijo de Homebrew es: $HOMEBREW_PREFIX"
fi

echo -e "âœ… Ruta de homebrew: $scripts_dir"
source "$scripts_dir/android/android.sh"
source "$scripts_dir/android/android_support.sh"
source "$scripts_dir/android/android_create_new_project.sh"
source "$scripts_dir/android/android_template.sh"
source "$scripts_dir/ios/ios.sh"
source "$scripts_dir/ios/ios_support.sh"
source "$scripts_dir/ios/ios_template.sh"
source "$scripts_dir/ios/ios_create_new_project.sh"
source "$scripts_dir/flutter/flutter.sh"
source "$scripts_dir/flutter/flutter_support.sh"
source "$scripts_dir/flutter/flutter_create_new_project.sh"
source "$scripts_dir/flutter/flutter_template.sh"
source "$scripts_dir/python/python.sh"
source "$scripts_dir/python/python_create_project.sh"
source "$scripts_dir/python/python_template.sh"
source "$scripts_dir/support/general_support.sh"
source "$scripts_dir/support/git.sh"
source "$scripts_dir/support/network.sh"
source "$scripts_dir/support/os.sh"
source "$scripts_dir/support/validation.sh"

echo -e "âœ… Imports cargados correctamente"

check_version

echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Inicializar variables
LIST_TEMPLATES="false"
TEMPLATE_TYPE=""
ARCHETYPE_TYPE=""
FORCE_INSTALL="false"
export FORCE_INSTALL

function cleanup {
    echo ""
    echo -e "${YELLOW}ğŸ§¹ Ejecutando limpieza...${NC}"
    remove_temporary_dir
}

function cleanup_on_exit {
    # Limpieza sin exit para evitar loop infinito
    if [ -d "$TEMPORARY_DIR" ]; then
        rm -rf "$TEMPORARY_DIR"
    fi
    
    # Limpiar directorio temp-gula si existe
    if [ -d "temp-gula" ]; then
        echo -e "ğŸ—‘ï¸ Eliminando directorio temp-gula..."
        rm -rf "temp-gula"
    fi
    
    # Limpiar cualquier directorio temporal relacionado con arquetipo
    for temp_dir in temp-archetype architecture-* temp-*; do
        if [ -d "$temp_dir" ]; then
            rm -rf "$temp_dir"
        fi
    done
}

# Asociar seÃ±ales con las funciones de limpieza
trap cleanup SIGINT SIGTERM
trap cleanup_on_exit EXIT

install_module() {
  if check_type_of_project; then
    type=0
  else
    type=$?
  fi

  case "$type" in
    0) echo -e "${GREEN}Te encuentras en un proyecto Android${NC}"; install_android_module ;;
    1) echo -e "${GREEN}Te encuentras en un proyecto IOS${NC}";     install_ios_module ;;
    2) echo -e "${GREEN}Te encuentras en un proyecto Flutter${NC}";  install_flutter_module ;;
    3) echo -e "${GREEN}Te encuentras en un proyecto Python${NC}";   install_python_module ;;
    *) echo -e "${RED}Error: No te encuentras en un proyecto vÃ¡lido.${NC}"; exit 1 ;;
  esac
}

show_help() {
  echo ""
  echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo -e "${BOLD}                    GULA - AYUDA                 ${NC}"
  echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""
  echo -e "${BOLD}DESCRIPCIÃ“N:${NC}"
  echo "  Herramienta CLI para acelerar el desarrollo con arquetÃ­picos y mÃ³dulos"
  echo "  predefinidos. Soporta proyectos Android, iOS, Flutter y Python."
  echo ""
  echo -e "${BOLD}USO:${NC}"
  echo "  gula <comando> [opciones]"
  echo ""
  echo -e "${BOLD}COMANDOS PRINCIPALES:${NC}"
  echo ""
  echo -e "${BOLD}  list${NC}     Lista mÃ³dulos disponibles para el proyecto actual"
  echo -e "${BOLD}  install${NC}  Instala un mÃ³dulo especÃ­fico en el proyecto actual"
  echo -e "${BOLD}  create${NC}   Crea un nuevo proyecto con arquitectura predefinida"
  echo -e "${BOLD}  template${NC} Genera templates con arquitecturas predefinidas"
  echo -e "${BOLD}  branches${NC} Lista ramas disponibles en repositorios de mÃ³dulos o arquetipos"
  echo -e "${BOLD}  status${NC}   Muestra el estado del proyecto y mÃ³dulos instalados"
  echo -e "${BOLD}  validate${NC} Valida archivos configuration.gula del proyecto"
  echo -e "${BOLD}  install-hook${NC} Instala pre-commit hook para validar configuration.gula"
  echo -e "${BOLD}  help${NC}     Muestra esta ayuda"
  echo ""
  echo -e "${BOLD}OPCIONES GLOBALES:${NC}"
  echo ""
  echo -e "${BOLD}  --key=XXXX${NC}      Clave de acceso para repositorios privados (requerida para install/list/create/branches)"
  echo -e "${BOLD}  --branch=YYYY${NC}    Rama especÃ­fica del repositorio (opcional para install/list/create)"
  echo -e "${BOLD}  --type=ZZZZ${NC}     Tipo de template: clean|fastapi (para template)"
  echo -e "${BOLD}  --archetype=ZZZZ${NC} Plataforma de arquetipos: android|ios|flutter|python (para branches)"
  echo -e "${BOLD}  --force${NC}         Forzar reinstalaciÃ³n sin confirmar (para install)"
  echo -e "${BOLD}  --list${NC}          Lista todos los templates disponibles (para template)"
  echo -e "${BOLD}  --help, -h${NC}      Muestra esta ayuda"
  echo ""
  echo -e "${BOLD}EJEMPLOS DE USO:${NC}"
  echo ""
  echo -e "${BOLD}  Listar mÃ³dulos disponibles:${NC}"
  echo "  gula list --key=mi_clave_secreta"
  echo "  gula list --key=mi_clave --branch=development"
  echo ""
  echo -e "${BOLD}  Instalar un mÃ³dulo:${NC}"
  echo "  gula install authentication --key=mi_clave_secreta"
  echo "  gula install network --key=mi_clave --branch=feature-branch"
  echo "  gula install authentication --key=mi_clave --force     # Reinstalar sin confirmar"
  echo ""
  echo -e "${BOLD}  Crear nuevos proyectos:${NC}"
  echo "  gula create android --key=mi_clave_secreta"
  echo "  gula create flutter --key=mi_clave_secreta"
  echo "  gula create ios --key=mi_clave_secreta"
  echo "  gula create python --key=mi_clave_secreta"
  echo ""
  echo -e "${BOLD}  Generar templates:${NC}"
  echo "  gula template user"
  echo "  gula template product --type=clean"
  echo "  gula template user,product,order    # MÃºltiples templates"
  echo "  gula template --list               # Ver todos los templates disponibles"
  echo ""
  echo -e "${BOLD}  Listar ramas disponibles:${NC}"
  echo "  gula branches --key=mi_clave                    # Auto-detecta el tipo de proyecto"
  echo "  gula branches --key=mi_clave --archetype=flutter # Para consultar arquetipos"
  echo ""
  echo -e "${BOLD}  Ver estado del proyecto:${NC}"
  echo "  gula status                                     # Muestra mÃ³dulos instalados y logs"
  echo ""
  echo -e "${BOLD}  Validar configuration.gula:${NC}"
  echo "  gula validate                                   # Valida todos los configuration.gula del proyecto"
  echo "  gula validate --staged                          # Valida solo los archivos en staging (pre-commit)"
  echo ""
  echo -e "${BOLD}  Instalar pre-commit hook:${NC}"
  echo "  gula install-hook                               # Instala hook para validar en cada commit"
  echo ""
  echo -e "${BOLD}TIPOS DE PROYECTO SOPORTADOS:${NC}"
  echo ""
  echo -e "${BOLD}  ğŸ“± Android${NC}   - Proyectos nativos Android con Clean Architecture"
  echo -e "${BOLD}  ğŸ iOS${NC}       - Proyectos nativos iOS con Clean Architecture"
  echo -e "${BOLD}  ğŸ¦‹ Flutter${NC}   - Aplicaciones multiplataforma Flutter"
  echo -e "${BOLD}  ğŸ Python${NC}    - APIs backend con FastAPI o Django"
  echo ""
  echo -e "${BOLD}ARQUITECTURAS DISPONIBLES:${NC}"
  echo ""
  echo -e "${BOLD}  ğŸ“± Android & iOS${NC}     - Clean Architecture (Repository, UseCase, ViewModel)"
  echo -e "${BOLD}  ğŸ¦‹ Flutter${NC}           - Clean Architecture (BLoC, Repository, UseCase)"
  echo -e "${BOLD}  ğŸ Python${NC}            - Arquitectura Hexagonal (Adaptadores y Puertos)"
  echo ""
  echo -e "${BOLD}NOTAS:${NC}"
  echo ""
  echo "  â€¢ ${BOLD}template${NC}: No requiere --key (usa templates locales)"
  echo "  â€¢ ${BOLD}install/list${NC}: Requiere --key para acceder a repositorios privados"
  echo "  â€¢ ${BOLD}create${NC}: Requiere --key para descargar arquetipos"
  echo "  â€¢ ${BOLD}validate${NC}: Valida archivos configuration.gula del proyecto"
  echo "  â€¢ ${BOLD}install-hook${NC}: Instala pre-commit hook para validaciÃ³n automÃ¡tica"
  echo "  â€¢ La opciÃ³n --branch permite usar ramas especÃ­ficas en install/list/create"
  echo "  â€¢ La opciÃ³n --force permite reinstalar mÃ³dulos sin confirmaciÃ³n"
  echo "  â€¢ Los comandos list/install detectan automÃ¡ticamente el tipo de proyecto actual"
  echo "  â€¢ El comando create requiere especificar la plataforma (android/ios/flutter/python)"
  echo "  â€¢ Todas las operaciones se registran en el archivo .gula.log (formato JSON)"
  echo "  â€¢ Use 'gula status' para ver el historial de operaciones y mÃ³dulos instalados"
  echo ""
  echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

help_modules() {
  show_help
}

list_modules() {
  if check_type_of_project; then
    type=0
  else
    type=$?
  fi

  case "$type" in
    0) echo -e "${GREEN}Te encuentras en un proyecto Android${NC}"; list_android ;;
    1) echo -e "${GREEN}Te encuentras en un proyecto IOS${NC}";     list_ios ;;
    2) echo -e "${GREEN}Te encuentras en un proyecto Flutter${NC}";  list_flutter ;;
    3) echo -e "${GREEN}Te encuentras en un proyecto Python${NC}";   list_python ;;
    *) echo -e "${RED}Error: No te encuentras en un proyecto vÃ¡lido.${NC}"; exit 1 ;;
  esac
}

list_templates() {
  if [ "$LIST_TEMPLATES" = "true" ]; then
    echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BOLD}           TEMPLATES DISPONIBLES                ${NC}"
    echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${BOLD}ğŸ“± Android:${NC}"
    echo "  â€¢ clean - Clean Architecture (Repository, UseCase, ViewModel)"
    echo ""
    echo -e "${BOLD}ğŸ iOS:${NC}"
    echo "  â€¢ clean - Clean Architecture (SwiftUI + Repository + UseCase)"
    echo ""
    echo -e "${BOLD}ğŸ¦‹ Flutter:${NC}"
    echo "  â€¢ clean - Clean Architecture (BLoC + Repository + UseCase)"
    echo ""
    echo -e "${BOLD}ğŸ Python:${NC}"
    echo "  â€¢ fastapi - Arquitectura Hexagonal (Adaptadores y Puertos Driven/Driving)"
    echo ""
    echo -e "${BOLD}Uso:${NC}"
    echo "  gula template <nombre> [--type=clean]"
    echo ""
    echo -e "${BOLD}Ejemplos:${NC}"
    echo "  gula template user"
    echo "  gula template product --type=clean"
    echo "  gula template user,product,order"
    echo ""
    echo -e "${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    exit 0
  fi
}

install_single_template() {
  local template_name=$1
  
  if check_type_of_project; then
    type=0
  else
    type=$?
  fi

  # Guardar MODULE_NAME original y asignar el template actual
  local original_module_name="$MODULE_NAME"
  MODULE_NAME="$template_name"

  case "$type" in
    0) echo -e "${GREEN}Te encuentras en un proyecto Android${NC}"; install_templates_android ;;
    1) echo -e "${GREEN}Te encuentras en un proyecto IOS${NC}";     install_templates_ios ;;
    2) echo -e "${GREEN}Te encuentras en un proyecto Flutter${NC}";  install_templates_flutter ;;
    3) echo -e "${GREEN}Te encuentras en un proyecto Python${NC}";   install_templates_python ;;
    *) echo -e "${RED}Error: No te encuentras en un proyecto vÃ¡lido.${NC}"; exit 1 ;;
  esac
  
  # Restaurar MODULE_NAME original
  MODULE_NAME="$original_module_name"
}

install_template() {
  # Verificar si MODULE_NAME contiene comas (mÃºltiples templates)
  if [[ "$MODULE_NAME" == *","* ]]; then
    echo -e "${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "${BOLD}ğŸš€ GENERACIÃ“N BATCH DE TEMPLATES${NC}"
    echo -e "${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    
    # Dividir MODULE_NAME por comas
    IFS=',' read -ra TEMPLATES <<< "$MODULE_NAME"
    
    echo -e "${YELLOW}Se generarÃ¡n ${#TEMPLATES[@]} templates: ${TEMPLATES[*]}${NC}"
    echo ""
    
    for template in "${TEMPLATES[@]}"; do
      # Limpiar espacios en blanco
      template=$(echo "$template" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
      
      if [ -n "$template" ]; then
        echo -e "${BOLD}ğŸ“ Generando template: $template${NC}"
        install_single_template "$template"
        echo ""
      fi
    done
    
    echo -e "${GREEN}âœ… Todos los templates han sido generados correctamente!${NC}"
  else
    # Un solo template
    install_single_template "$MODULE_NAME"
  fi
}

create_project() {
  echo ""
  if [[ "$MODULE_NAME" == "ios" ]]; then
    echo -e "${GREEN}Empezando la instalaciÃ³n del arquetipo para ios${NC}"
    echo ""
    ios_create_project
  elif [[ "$MODULE_NAME" == "android" ]]; then
    echo -e "${GREEN}Empezando la instalaciÃ³n del arquetipo para android${NC}"
    echo ""
    android_create_project
  elif [[ "$MODULE_NAME" == "flutter" ]]; then
    echo -e "${GREEN}Empezando la instalaciÃ³n del arquetipo para Flutter${NC}"
    echo ""
    flutter_create_project
  elif [[ "$MODULE_NAME" == "python" ]]; then
    echo -e "${GREEN}Empezando la instalaciÃ³n del arquetipo para Python${NC}"
    echo ""
    python_create_project
  else 
    echo -e "${RED}Error: solo esta permitido como opciÃ³n: ios, android, flutter o python.${NC}"
    echo ""
    exit 0
  fi  
}


# Verificar que se haya pasado un comando vÃ¡lido
if [ -z "$1" ]; then
  echo "Uso: $0 {install|list|template|create|branches|status|validate|install-hook|help} [opciones]"
  echo "Usa '$0 --help' para mÃ¡s informaciÃ³n."
  exit 1
fi

# Procesar los argumentos
COMMAND="$1"
# Manejar --help como primer argumento
if [[ "$COMMAND" == "--help" || "$COMMAND" == "-h" ]]; then
  COMMAND="help"
fi

# Manejar caso especial: gula template --list
if [[ "$COMMAND" == "template" && "$2" == "--list" ]]; then
  LIST_TEMPLATES="true"
  MODULE_NAME=""
elif [[ "$COMMAND" == "template" && -n "$2" && "$2" != "--list" ]]; then
  MODULE_NAME="$2"
fi

# Manejar caso especial: gula validate --staged
VALIDATE_STAGED="false"
if [[ "$COMMAND" == "validate" && "${2:-}" == "--staged" ]]; then
  VALIDATE_STAGED="true"
fi

shift

while [[ "$#" -gt 0 ]]; do
  case "$1" in
    --key=*)
      KEY="${1#*=}"
      ;;
    --branch=*)
      BRANCH="${1#*=}"
      ;;
    --type=*)
      TEMPLATE_TYPE="${1#*=}"
      ;;
    --archetype=*)
      ARCHETYPE_TYPE="${1#*=}"
      ;;
    --force)
      FORCE_INSTALL="true"
      export FORCE_INSTALL
      ;;
    --list)
      LIST_TEMPLATES="true"
      ;;
    --help|-h)
      COMMAND="help"
      ;;
    install)
      COMMAND="install"
      if [ -n "${2:-}" ]; then
        MODULE_NAME="$2"
        shift
      fi
      ;;
    list)
      COMMAND="list"
      ;;
    branches)
      COMMAND="branches"
      ;;
    status)
      COMMAND="status"
      ;;
    validate)
      COMMAND="validate"
      ;;
    install-hook)
      COMMAND="install-hook"
      ;;
    help)
      COMMAND="help"
      ;;
    create)
      COMMAND="create"
      if [ -n "${2:-}" ]; then
        MODULE_NAME="$2"
        shift
      fi
      ;;
    template)
      COMMAND="template"
      MODULE_NAME="$2"
      shift
      ;;
    *)
      MODULE_NAME="$1"
      ;;
  esac
  shift
done  

# Limpiar directorio temporal antes de ejecutar cualquier comando
cleanup_temp_directory

if [ "$COMMAND" == "install" ]; then
  if [ -z "$MODULE_NAME" ]; then
    echo "Uso: $0 install <module_name> [--key=xxxx]"
    exit 1
  fi
  install_module "$MODULE_NAME"
elif [ "$COMMAND" == "list" ]; then
  list_modules
elif [ "$COMMAND" == "help" ]; then
  show_help
elif [ "$COMMAND" == "template" ]; then
  if [ "$LIST_TEMPLATES" == "true" ]; then
    list_templates
  elif [ -z "$MODULE_NAME" ]; then
    echo "Uso: $0 template <module_name> [--type=clean] [--list]"
    exit 1
  else
    install_template "$MODULE_NAME"
  fi
elif [ "$COMMAND" == "create" ]; then
  if [ -z "$MODULE_NAME" ]; then
    echo "Uso: $0 create <platform {ios}>"
    exit 1
  fi
  create_project "$MODULE_NAME"
elif [ "$COMMAND" == "branches" ]; then
  if [ -z "$KEY" ]; then
    echo "Uso: $0 branches --key=xxxx [--archetype=<platform>]"
    echo "Plataformas vÃ¡lidas para archetype: android, ios, flutter, python"
    exit 1
  fi
  
  if [ -n "$ARCHETYPE_TYPE" ]; then
    # Consultar ramas de arquetipos
    get_access_token "$KEY" "$ARCHETYPE_TYPE"
    list_branches "archetype-$ARCHETYPE_TYPE"
  else
    # Detectar automÃ¡ticamente el tipo de proyecto
    if check_type_of_project; then
      type=0
    else
      type=$?
    fi

    case "$type" in
      0) 
        echo -e "${GREEN}Detectado proyecto Android${NC}"
        get_access_token "$KEY" "android"
        list_branches "android"
        ;;
      1) 
        echo -e "${GREEN}Detectado proyecto iOS${NC}"
        get_access_token "$KEY" "ios"
        list_branches "ios"
        ;;
      2) 
        echo -e "${GREEN}Detectado proyecto Flutter${NC}"
        get_access_token "$KEY" "flutter"
        list_branches "flutter"
        ;;
      3) 
        echo -e "${GREEN}Detectado proyecto Python${NC}"
        get_access_token "$KEY" "back"
        list_branches "python"
        ;;
      *) 
        echo -e "${RED}Error: No se detectÃ³ un tipo de proyecto vÃ¡lido.${NC}"
        echo "Si quieres consultar ramas de arquetipos usa: $0 branches --key=xxxx --archetype=<platform>"
        exit 1
        ;;
    esac
  fi
elif [ "$COMMAND" == "status" ]; then
  show_project_status
elif [ "$COMMAND" == "validate" ]; then
  if [ "$VALIDATE_STAGED" == "true" ]; then
    validate_staged_configurations
  else
    validate_configuration_files
  fi
elif [ "$COMMAND" == "install-hook" ]; then
  install_validation_hook
else
  echo "Comando no reconocido. Uso: $0 {install|list|template|create|branches|status|validate|install-hook|help} [--key=xxxx] [--branch=yyyy]"
  echo "Usa '$0 --help' para obtener ayuda detallada."
  exit 1
fi